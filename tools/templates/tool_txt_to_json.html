{% extends 'base.html' %}
{% load static %}
{% block content %}

<div class="container mt-5">
    <h2 class="mb-4 text-center">Convert Text to JSON</h2>

    <!-- Form for selecting number of text areas -->
    <div class="row justify-content-center">
        <div class="col-md-8">
            <form id="file-number-form" class="border p-4 rounded shadow-sm bg-light">
                {% csrf_token %}
                <div class="form-group">
                    <label for="number_of_textareas">Number of text areas:</label>
                    <input type="number" id="number_of_textareas" min="1" value="1" class="form-control form-control-sm">
                </div>
                <button type="button" id="generate-textareas" class="btn btn-primary mt-3">Generate</button>
            </form>
        </div>
    </div>

    <!-- Text areas form, initially hidden -->
    <form method="POST" id="text-form" class="mt-4">
        {% csrf_token %}
        <div id="textareas-container" style="display: none;">
            <div id="textareas-wrapper" class="mt-3"></div>
        </div>

        <!-- Convert to JSON button, initially hidden -->
        <div id="submit-form-container" class="mt-4" style="display: none;">
            <button type="button" class="btn btn-success btn-block" onclick="downloadJSON()">Convert to JSON</button>
        </div>
    </form>

    <!-- Success message and file download link -->
    {% if success_message %}
        <div class="mt-4">
            <h3>Success!</h3>
            <p>{{ success_message }}</p>
            <p>Files created:</p>
            <ul>
                {% for file_name in file_names %}
                    <li>{{ file_name }}</li>
                {% endfor %}
            </ul>
            <a id="download-link" href="{{ download_url }}" class="btn btn-primary mt-2">Download All as ZIP</a>
            <a href="{% url 'tools:export_txt_to_json' %}" class="btn btn-secondary mt-2">Refresh</a>
        </div>

        <!-- Auto download ZIP link -->
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                var downloadLink = document.getElementById('download-link');
                if (downloadLink) {
                    downloadLink.click();
                }
            });
        </script>
    {% endif %}
</div>

<!-- JS for text areas generation and JSON download -->
<script>
document.getElementById('generate-textareas').addEventListener('click', function() {
    var numTextAreas = parseInt(document.getElementById('number_of_textareas').value, 10);
    var textareasContainer = document.getElementById('textareas-container');
    var textareasWrapper = document.getElementById('textareas-wrapper');

    // Clear existing text areas
    textareasWrapper.innerHTML = '';

    // Create new text areas
    for (var i = 0; i < numTextAreas; i++) {
        var textarea = document.createElement('textarea');
        textarea.name = 'texts';
        textarea.id = 'textarea_' + i;
        textarea.rows = 5;
        textarea.cols = 50;
        textarea.placeholder = 'Enter text for JSON ' + (i + 1);
        textarea.classList.add('form-control', 'mb-2', 'rounded');
        textareasWrapper.appendChild(textarea);
    }

    // Show text areas and submit button
    textareasContainer.style.display = 'block';
    document.getElementById('submit-form-container').style.display = 'block';
});

// Function to convert text areas to JSON and download as ZIP
function downloadJSON() {
    document.getElementById('text-form').submit();  // Gửi form tới máy chủ
}
</script>

{% endblock %}
