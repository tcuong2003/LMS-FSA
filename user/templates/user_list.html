{% extends 'base.html' %}
{% load static %}
{% load custome_filters %}
{% block title %}User List{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/user_list.css' %}">
<div class="container mt-4">
    <ul class="nav nav-tabs">
        <li class="nav-item">
            <a class="nav-link active" href="{% url 'user:user_list' %}">Users</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="{% url 'user:student_list' %}">Students</a>
        </li>
    </ul>

    <div class="mt-3">
        <div class="d-flex justify-content-between align-items-center">
            <div class="btn-group mt-3">
                {% if request.user.is_authenticated and can_export_users %}
                    <button class="btn btn-secondary" title="Export Users" data-toggle="modal" data-target="#exportModal" data-toggle="tooltip">
                        <i class="fas fa-file-export"></i> Export
                    </button>

                    <!-- Modal Export -->
                    <div class="modal fade" id="exportModal" tabindex="-1" role="dialog" aria-labelledby="exportModalLabel" aria-hidden="true">
                        <div class="modal-dialog" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="exportModalLabel">Export Users</h5>
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <form method="GET" action="{% url 'user:export_users' %}">
                                    <div class="modal-body">
                                        <select name="format" class="form-select" aria-label="Export Format">
                                            <option value="csv">Export to CSV</option>
                                            <option value="yaml">Export to YAML</option>
                                            <option value="json">Export to JSON</option>
                                            <option value="tsv">Export to TSV</option>
                                            <option value="xlsx">Export to Excel</option>
                                        </select>
                                        <input type="hidden" name="role" value="{{ selected_role }}">
                                        <input type="hidden" name="q" value="{{ query }}">
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                        <button type="submit" class="btn btn-primary">Export</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                {% endif %}
                <a href="{% url 'user:user_list' %}" class="btn btn-secondary" title="Refresh User List" id="refresh_button">
                    <i class="fas fa-sync-alt"></i> Refresh
                </a>
            </div>
            <form method="GET" action="{% url 'user:user_list' %}" class="form-inline">
                <div class="input-group">
                    <input type="text" name="q" value="{{ query|default_if_none:'' }}" class="form-control" placeholder="Search users..." aria-label="Search users">
                    <select name="role" class="form-control ms-2">
                        <option value="">Select Role</option>
                        {% for role in roles %}
                            <option value="{{ role.role_name }}" {% if role.role_name == selected_role %}selected{% endif %}>{{ role.role_name }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit" class="btn btn-outline-success ms-2">Search</button>
                </div>
            </form>  
        </div>

        <!-- Form x·ª≠ l√Ω x√≥a nhi·ªÅu ng∆∞·ªùi d√πng -->
        <form id="delete_form" method="POST" action="{% url 'user:user_delete' %}">
            {% csrf_token %}
            <div class="btn-group mt-3">
                {% if request.user.is_authenticated and can_add_user %}
                    <a href="{% url 'user:user_add' %}" class="btn btn-primary" title="Add New User">
                        <i class="fas fa-plus"></i> Add User
                    </a>
                {% endif %}
                {% if request.user.is_authenticated and can_delete_user %}
                    <button type="button" id="delete_button" class="btn btn-danger" title="Delete Selected Users" data-toggle="tooltip">
                        <i class="fas fa-trash-alt"></i> Delete
                    </button>
                {% endif %}
            </div>
        
            <table class="table table-striped mt-3">
                <thead>
                    <tr>
                        <th>
                            <input type="checkbox" id="select_all">
                        </th>
                        <th>#</th>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Full Name</th>
                        {% if request.user.profile.role.role_name == 'Manager' or request.user.is_superuser %}
                            <th>Role</th>
                        {% endif %}
                        <th class="text-center">Profile Picture</th>
                        {% if request.user.profile.role.role_name == 'Manager' or request.user.is_superuser %}
                            <th>Actions</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <td>
                            <input type="checkbox" name="selected_users" value="{{ user.pk }}" class="user-checkbox">
                        </td>
                        <td>{{ users.number|add:'-1'|multiply:5|add:forloop.counter }}</td>
                        <td>{{ user.username }}</td>
                        <td>{{ user.email }}</td>
                        <td>{{ user.first_name }} {{ user.last_name }}</td>
                        {% if request.user.profile.role.role_name == 'Manager' or request.user.is_superuser %}
                            <td>{{ user.profile.role.role_name }}</td>
                        {% endif %}
                        <td class="text-center">
                            {% if user.profile.profile_picture_url %}
                                <img src="{{ user.profile.profile_picture_url }}" alt="Profile Picture" class="img-fluid" style="width: 100px; height: 100px; object-fit: cover; margin: auto; display: block;">
                            {% else %}
                                No image
                            {% endif %}
                        </td>
                        <td>
                            {% if request.user.is_authenticated and can_detail_user %}
                                <a href="{% url 'user:user_detail' user.pk %}" class="btn btn-info btn-sm" title="View User Details" data-toggle="tooltip">
                                    <i class="fas fa-info-circle"></i>
                                </a>
                            {% endif %}
                            {% if request.user.is_authenticated and can_edit_user %}
                                <a href="{% url 'user:user_edit' user.pk %}" class="btn btn-warning btn-sm" title="Edit User" data-toggle="tooltip">
                                    <i class="fas fa-edit"></i>
                                </a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
        </form>
        

        <!-- Ph√¢n trang -->
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1&search={{ query }}" aria-label="First">
                            <span aria-hidden="true">&laquo;&laquo;</span>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}&search={{ query }}" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                        <li class="page-item active" aria-current="page"><span class="page-link">{{ num }}</span></li>
                    {% else %}
                        <li class="page-item"><a class="page-link" href="?page={{ num }}&search={{ query }}">{{ num }}</a></li>
                    {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}&search={{ query }}" aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}&search={{ query }}" aria-label="Last">
                            <span aria-hidden="true">&raquo;&raquo;</span>
                        </a>
                    </li>
                {% endif %}
            </ul>
        </nav>

        <!-- Th√¥ng b√°o -->
        {% if messages %}
            <div class="mt-3">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        <i class="fas fa-{{ message.tags }}"></i>
                        {{ message }}
                       
                    </div>
                {% endfor %}
            </div>
        {% endif %}
        <!-- ############### IMPORT##################### -->
        <form id="importForm" method="POST" enctype="multipart/form-data" action="{% url 'user:import_users' %}">
            {% csrf_token %}
            <div class="mt-4 text-center">
                <h5>Choose a file (XLSX, CSV, JSON)</h5>
                <div id="drop_area" class="drag-area" style="border: 2px dashed #ccc; padding: 30px; cursor: pointer;">
                    <p>Drag and drop file here or click to browse</p>
                    <small>Limit 200MB per file ‚Ä¢ <span id="fileName"></span></small>
                    <input type="file" id="file" name="file" class="form-control" accept=".xlsx, .csv, .json" style="display: none;">
                </div>
            </div>
        
            <!-- Table to display file content -->
            <div id="filePreview" style="display:none;" class="file-preview mt-3">
                <h5>File Preview</h5>
                <div id="searchContainer" style="display: none;">
                    <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm...">
                </div>
                <div id="searchIcon" style="display: none; cursor: pointer;">üîç</div>
                <div id="fullscreenIcon" style="display: none; cursor: pointer;">üñ•Ô∏è</div>
            
                <div class="previewTable" style="overflow: auto; border: 1px solid #ccc;">
                    <table class="table table-bordered" id="previewTable" style="width: 100%;">
                        <thead>
                            <tr id="previewHeader">
                                <!-- Th√™m c√°c th·∫ª <th> v√†o ƒë√¢y -->
                            </tr>
                        </thead>
                        <tbody id="previewBody">
                            <!-- Th√™m c√°c d√≤ng d·ªØ li·ªáu v√†o ƒë√¢y -->
                        </tbody>
                    </table>
                </div>
            
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="closeButton">Close</button>
                    <button type="submit" id="confirmImport" class="btn btn-primary" disabled>Confirm Import</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    document.getElementById('fullscreenIcon').addEventListener('click', function() {
        const previewTable = document.querySelector('.previewTable'); // L·∫•y b·∫£ng xem tr∆∞·ªõc
        const navbar = document.querySelector('.navbar'); // L·∫•y thanh navbar
        const pagination = document.querySelector('.pagination'); // L·∫•y ph·∫ßn ph√¢n trang
        const body = document.body; // L·∫•y th·∫ª body
        
        previewTable.classList.toggle('fullscreen'); // Thay ƒë·ªïi tr·∫°ng th√°i full screen
        
        if (previewTable.classList.contains('fullscreen')) {
            this.innerHTML = '‚ùå'; // Thay ƒë·ªïi bi·ªÉu t∆∞·ª£ng th√†nh n√∫t tho√°t
            navbar.classList.add('navbar-hidden'); // ·∫®n navbar
            pagination.style.display = 'none'; // ·∫®n ph·∫ßn ph√¢n trang
            previewTable.style.zIndex = '999999'; // ƒê·∫£m b·∫£o b·∫£ng n·∫±m tr√™n c√πng
            body.classList.add('fullscreen'); // Th√™m l·ªõp ƒë·ªÉ ·∫©n thanh cu·ªôn
            window.scrollTo(0, 0); // Cu·ªôn l√™n ƒë·∫ßu trang
        } else {
            this.innerHTML = 'üñ•Ô∏è'; // Kh√¥i ph·ª•c bi·ªÉu t∆∞·ª£ng ph√≥ng to
            navbar.classList.remove('navbar-hidden'); // Hi·ªÉn th·ªã l·∫°i navbar
            pagination.style.display = ''; // Hi·ªÉn th·ªã l·∫°i ph·∫ßn ph√¢n trang
            previewTable.style.zIndex = ''; // Kh√¥i ph·ª•c z-index ban ƒë·∫ßu
            body.classList.remove('fullscreen'); // X√≥a l·ªõp ƒë·ªÉ hi·ªÉn th·ªã thanh cu·ªôn
        }
    });
    
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const dropArea = document.getElementById('drop_area');
        const fileInput = document.getElementById('file');
        const previewHeader = document.getElementById('previewHeader');
        const previewBody = document.getElementById('previewBody');
        const filePreview = document.getElementById('filePreview');
        const confirmImportButton = document.getElementById('confirmImport');
        const fileNameDisplay = document.getElementById('fileName');
        const searchInput = document.getElementById('searchInput');
        const searchContainer = document.getElementById('searchContainer'); // √î t√¨m ki·∫øm
        const searchIcon = document.getElementById('searchIcon'); // Bi·ªÉu t∆∞·ª£ng t√¨m ki·∫øm
        const fullscreenIcon = document.getElementById('fullscreenIcon');
        
        let hideIconsTimeout;
        let isFullscreen = false; // Bi·∫øn ƒë·ªÉ ki·ªÉm tra tr·∫°ng th√°i fullscreen
        let previousStyles = {};

        // Khi nh·∫•p v√†o v√πng k√©o v√† th·∫£, m·ªü h·ªôp tho·∫°i t·ªáp
        dropArea.addEventListener('click', function() {
            fileInput.click();
        });
    
        // NgƒÉn ch·∫∑n h√†nh vi m·∫∑c ƒë·ªãnh khi k√©o t·ªáp
        dropArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            dropArea.style.borderColor = 'green';
        });
    
        // ƒê·∫∑t l·∫°i m√†u vi·ªÅn khi r·ªùi kh·ªèi khu v·ª±c k√©o
        dropArea.addEventListener('dragleave', function() {
            dropArea.style.borderColor = '#ccc';
        });
    
        // X·ª≠ l√Ω th·∫£ t·ªáp
        dropArea.addEventListener('drop', function(e) {
            e.preventDefault();
            dropArea.style.borderColor = '#ccc';
            const files = e.dataTransfer.files;
    
            if (files.length > 0) {
                fileInput.files = files;
                fileNameDisplay.textContent = files[0].name;
                readFile(files[0]);
            }
        });
    
        // Khi ng∆∞·ªùi d√πng ch·ªçn t·ªáp qua input
        fileInput.addEventListener('change', function() {
            if (fileInput.files.length > 0) {
                const fileName = fileInput.files[0].name;
                fileNameDisplay.textContent = fileName;
                readFile(fileInput.files[0]);
            }
        });
    
        // H√†m ƒë·ªçc t·ªáp v√† hi·ªÉn th·ªã b·∫£n xem tr∆∞·ªõc
        function readFile(file) {
            const reader = new FileReader();
        
            if (file.type === "application/json") {
                reader.onload = function(e) {
                    const content = e.target.result;
                    displayPreview(content, file.type);
                };
                reader.readAsText(file);
            } else if (file.type === "text/csv") {
                reader.onload = function(e) {
                    const content = e.target.result;
                    displayPreview(content, file.type);
                };
                reader.readAsText(file);
            } else if (file.type === "text/tab-separated-values" || file.name.endsWith(".tsv")) {
                reader.onload = function(e) {
                    const content = e.target.result;
                    displayPreview(content, "text/tab-separated-values");
                };
                reader.readAsText(file);
            } else if (file.type === "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" || file.type === "application/vnd.ms-excel") {
                reader.onload = function(e) {
                    const content = e.target.result;
                    displayExcelPreview(content);
                };
                reader.readAsArrayBuffer(file);
            } else if (file.type === "application/x-yaml" || file.type === "text/yaml" || file.name.endsWith(".yaml") || file.name.endsWith(".yml")) {
                reader.onload = function(e) {
                    const content = e.target.result;
                    displayYAMLPreview(content);
                };
                reader.readAsText(file);
            } else {
                alert("ƒê·ªãnh d·∫°ng t·ªáp kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£.");
            }
        }
        
        // C·∫≠p nh·∫≠t h√†m displayPreview ƒë·ªÉ x·ª≠ l√Ω JSON, CSV, v√† TSV
        function displayPreview(content, fileType) {
            const rows = [];
            let headers = [];
        
            if (fileType === "application/json") {
                const jsonData = JSON.parse(content);
                headers = Object.keys(jsonData[0]);
                jsonData.forEach(item => {
                    const row = headers.map(header => `<td>${item[header]}</td>`).join('');
                    rows.push(`<tr>${row}</tr>`);
                });
            } else if (fileType === "text/csv" || fileType === "text/tab-separated-values") {
                const lines = content.split('\n');
                const delimiter = fileType === "text/csv" ? ',' : '\t'; // Ph√¢n t√°ch theo d·∫•u ph·∫©y ho·∫∑c tab
                headers = lines[0].split(delimiter);
                lines.slice(1).forEach(line => {
                    const cells = line.split(delimiter);
                    const row = cells.map(cell => `<td>${cell}</td>`).join('');
                    rows.push(`<tr>${row}</tr>`);
                });
            }
        
            // Hi·ªÉn th·ªã b·∫£ng d·ªØ li·ªáu
            previewHeader.innerHTML = headers.map(header => `<th>${header}</th>`).join('');
            previewBody.innerHTML = rows.join('');
            filePreview.style.display = 'block';
            confirmImportButton.disabled = false;
            setupSearchFunctionality(rows, headers);
        }
        
        // H√†m hi·ªÉn th·ªã b·∫£n xem tr∆∞·ªõc cho t·ªáp YAML
        function displayYAMLPreview(content) {
            try {
                const yamlData = jsyaml.load(content); // S·ª≠ d·ª•ng jsyaml ƒë·ªÉ ph√¢n t√≠ch c√∫ ph√°p YAML
                const rows = [];
                const headers = Object.keys(yamlData[0]); // L·∫•y header t·ª´ d√≤ng ƒë·∫ßu ti√™n
        
                yamlData.forEach(item => {
                    const row = headers.map(header => `<td>${item[header]}</td>`).join('');
                    rows.push(`<tr>${row}</tr>`);
                });
        
                previewHeader.innerHTML = headers.map(header => `<th>${header}</th>`).join('');
                previewBody.innerHTML = rows.join('');
                filePreview.style.display = 'block';
                confirmImportButton.disabled = false;
                setupSearchFunctionality(rows, headers);
            } catch (e) {
                alert("L·ªói khi x·ª≠ l√Ω t·ªáp YAML: " + e.message);
            }
            
        }
        
        // H√†m hi·ªÉn th·ªã b·∫£n xem tr∆∞·ªõc cho t·ªáp Excel
        function displayExcelPreview(content) {
            const data = new Uint8Array(content);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
        
            const rows = [];
            const headers = jsonData[0];
        
            // Ki·ªÉm tra c·∫•u tr√∫c t·ªáp
            if (!isValidUserStructure(headers)) {
                alert("C·∫•u tr√∫c t·ªáp kh√¥ng h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra l·∫°i.");
                return;
            }
        
            jsonData.slice(1).forEach(row => {
                const tableRow = row.map(cell => `<td>${cell}</td>`).join('');
                rows.push(`<tr>${tableRow}</tr>`);
            });
        
            // Hi·ªÉn th·ªã b·∫£ng d·ªØ li·ªáu
            previewHeader.innerHTML = headers.map(header => `<th>${header}</th>`).join('');
            previewBody.innerHTML = rows.join('');
            filePreview.style.display = 'block';
            confirmImportButton.disabled = false;
        
            // ƒê·∫∑t s·ª± ki·ªán cho t√¨m ki·∫øm
            setupSearchFunctionality(rows, headers);
        }
        
        // H√†m ki·ªÉm tra c·∫•u tr√∫c t·ªáp
        function isValidUserStructure(headers) {
            const requiredHeaders = ['username', 'first_name', 'last_name', 'email', 'password', 'profile__role__role_name', 'profile__profile_picture_url', 'profile__bio', 'profile__interests', 'profile__learning_style', 'profile__preferred_language', 'student_code'];
            return requiredHeaders.every(header => headers.includes(header));
        }
    
        // H√†m thi·∫øt l·∫≠p ch·ª©c nƒÉng t√¨m ki·∫øm
        function setupSearchFunctionality(rows, headers) {
            // Hi·ªÉn th·ªã bi·ªÉu t∆∞·ª£ng t√¨m ki·∫øm khi di chu·ªôt v√†o b·∫£ng
            previewBody.parentElement.addEventListener('mouseenter', function() {
                searchIcon.style.display = 'inline';
                fullscreenIcon.style.display = 'inline';
                clearTimeout(hideIconsTimeout);
            });
        
            // ·∫®n bi·ªÉu t∆∞·ª£ng t√¨m ki·∫øm v√† to√†n m√†n h√¨nh khi r·ªùi kh·ªèi b·∫£ng
            previewBody.parentElement.addEventListener('mouseleave', function() {
                hideIconsTimeout = setTimeout(() => {
                    searchIcon.style.display = 'none'; 
                    fullscreenIcon.style.display = 'none'; 
                }, 1000);
            });
        
            // Hi·ªÉn th·ªã thanh t√¨m ki·∫øm khi nh·∫•p v√†o bi·ªÉu t∆∞·ª£ng t√¨m ki·∫øm
            searchIcon.addEventListener('click', function(event) {
                event.stopPropagation(); 
                if (searchContainer.style.display === 'block') {
                    searchContainer.style.display = 'none'; 
                } else {
                    searchContainer.style.display = 'block'; 
                    searchInput.focus(); 
                }
            });
        
            // S·ª± ki·ªán t√¨m ki·∫øm
            searchInput.addEventListener('input', function() {
                const searchTerm = searchInput.value.toLowerCase();
                const filteredRows = rows.filter(row => row.toLowerCase().includes(searchTerm));
                previewBody.innerHTML = filteredRows.join('');
            });
        
            // ƒê√≥ng thanh t√¨m ki·∫øm khi nh·∫•p ra ngo√†i
            document.addEventListener('click', function(event) {
                if (!searchContainer.contains(event.target) && searchContainer.style.display === 'block') {
                    searchContainer.style.display = 'none';
                }
            });
        
            // Ch·ª©c nƒÉng xem to√†n m√†n h√¨nh
            fullscreenIcon.addEventListener('click', function() {
                toggleFullscreen(previewBody.parentElement);
            });
        }
        
        // Th√™m s·ª± ki·ªán click cho bi·ªÉu t∆∞·ª£ng ph√≥ng to
        fullscreenIcon.addEventListener('click', function() {
            if (filePreview.classList.contains('fullscreen')) {
                // N·∫øu ƒëang ·ªü ch·∫ø ƒë·ªô ph√≥ng to, kh√¥i ph·ª•c l·∫°i k√≠ch th∆∞·ªõc ban ƒë·∫ßu
                filePreview.classList.remove('fullscreen'); // X√≥a l·ªõp fullscreen
                filePreview.style.width = '1100px'; // ƒê·∫∑t l·∫°i chi·ªÅu r·ªông
                filePreview.style.height = '400px'; // ƒê·∫∑t l·∫°i chi·ªÅu cao
                filePreview.style.position = ''; // Kh√¥i ph·ª•c thu·ªôc t√≠nh position
                filePreview.style.backgroundColor = ''; // Kh√¥i ph·ª•c m√†u n·ªÅn
                filePreview.style.color = ''; // Kh√¥i ph·ª•c m√†u ch·ªØ
            } else {
                // N·∫øu ch∆∞a ·ªü ch·∫ø ƒë·ªô ph√≥ng to, y√™u c·∫ßu ph√≥ng to
                filePreview.classList.add('fullscreen'); // Th√™m l·ªõp fullscreen
                adjustFullScreenStyles(); // G·ªçi h√†m ƒëi·ªÅu ch·ªânh ki·ªÉu d√°ng
            }
        });

        // H√†m ƒëi·ªÅu ch·ªânh ki·ªÉu d√°ng cho ch·∫ø ƒë·ªô to√†n m√†n h√¨nh
        function adjustFullScreenStyles() {
            filePreview.style.width = '100vw'; // Chi·∫øm to√†n b·ªô chi·ªÅu r·ªông
            filePreview.style.height = '100vh'; // Chi·∫øm to√†n b·ªô chi·ªÅu cao
            filePreview.style.position = 'fixed'; // ƒê·∫∑t v·ªã tr√≠ c·ªë ƒë·ªãnh
            filePreview.style.top = '0'; // ƒê·∫∑t ph·∫ßn t·ª≠ ·ªü tr√™n c√πng
            filePreview.style.left = '0'; // ƒê·∫∑t ph·∫ßn t·ª≠ ·ªü b√™n tr√°i
            filePreview.style.backgroundColor = 'white'; // M√†u n·ªÅn tr·∫Øng
            filePreview.style.color = 'black'; // M√†u ch·ªØ ƒëen
        }

        // H√†m l·ªçc h√†ng trong b·∫£ng d·ª±a tr√™n t·ª´ kh√≥a t√¨m ki·∫øm
        function filterRows(rows, headers, searchTerm) {
            const filteredRows = rows.filter(row => {
                const rowData = row.replace(/<td>|<\/td>/g, '').toLowerCase(); // Chuy·ªÉn ƒë·ªïi h√†ng th√†nh chu·ªói v√† lo·∫°i b·ªè th·∫ª td
                return rowData.includes(searchTerm);
            });
            previewBody.innerHTML = filteredRows.length > 0 ? filteredRows.join('') : '<tr><td colspan="' + headers.length + '">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£.</td></tr>';
        }

    });
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const storedCheckboxes = JSON.parse(localStorage.getItem('selectedUsers')) || {};
    const checkboxes = document.querySelectorAll('input[name="selected_users"]');

    // C·∫≠p nh·∫≠t tr·∫°ng th√°i checkbox d·ª±a tr√™n localStorage
    checkboxes.forEach(checkbox => {
        checkbox.checked = storedCheckboxes[checkbox.value] || false;
    });

    // L∆∞u tr·∫°ng th√°i checkbox v√†o localStorage khi checkbox ƒë∆∞·ª£c thay ƒë·ªïi
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            storedCheckboxes[checkbox.value] = checkbox.checked;
            localStorage.setItem('selectedUsers', JSON.stringify(storedCheckboxes));
        });
    });

    // Ch·ªçn t·∫•t c·∫£ checkbox
    const selectAllCheckbox = document.getElementById('select_all');
    selectAllCheckbox.addEventListener('change', function() {
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAllCheckbox.checked;
            storedCheckboxes[checkbox.value] = checkbox.checked; // C·∫≠p nh·∫≠t tr·∫°ng th√°i cho t·∫•t c·∫£
        });
        localStorage.setItem('selectedUsers', JSON.stringify(storedCheckboxes));
    });

    // X√≥a ng∆∞·ªùi d√πng ƒë√£ ch·ªçn
    document.getElementById('delete_button').addEventListener('click', function() {
        const selectedUsers = Object.keys(storedCheckboxes).filter(userId => storedCheckboxes[userId]);
        
        if (selectedUsers.length === 0) {
            alert('Please select at least one user to delete.');
            return;
        }
        if (confirm('Are you sure you want to delete the selected users?')) {
            const deleteForm = document.getElementById('delete_form');

            // T·∫°o c√°c input ·∫©n ƒë·ªÉ g·ª≠i c√°c gi√° tr·ªã ƒë√£ ch·ªçn
            selectedUsers.forEach(userId => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'selected_users'; // T√™n ph·∫£i kh·ªõp v·ªõi t√™n trong form
                input.value = userId;
                deleteForm.appendChild(input);
            });

            // Reset tr·∫°ng th√°i checkbox trong localStorage
            selectedUsers.forEach(userId => {
                delete storedCheckboxes[userId]; // X√≥a ng∆∞·ªùi d√πng ƒë√£ ch·ªçn kh·ªèi localStorage
            });
            localStorage.setItem('selectedUsers', JSON.stringify(storedCheckboxes));
            deleteForm.submit(); // G·ª≠i form x√≥a
        }
    });
    // X√≥a d·ªØ li·ªáu trong localStorage khi nh·∫•n n√∫t Refresh
    document.getElementById('refresh_button').addEventListener('click', function() {
        localStorage.removeItem('selectedUsers');
    });
});
    

// Kh·ªüi t·∫°o tooltip n·∫øu c·∫ßn
$(function () {
    $('[data-toggle="tooltip"]').tooltip();
});
</script>

{% endblock %}